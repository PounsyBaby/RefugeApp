generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum TypePersonne {
  prospect
  adoptant
  fa
  donateur
  multiple
}

enum RoleUtilisateur {
  admin
  agent
  benevole
  veto_ext
}

enum SexeAnimal {
  M
  F
  Inconnu
}

enum StatutAnimal {
  arrive
  quarantaine
  soin
  adoptable
  reserve
  adopte
  en_FA
  transfere
  decede
  indisponible
}

enum TypeEntree {
  abandon
  trouve
  saisie
  transfert
  autre
}

enum TypeActe {
  vaccin
  vermifuge
  test
  chirurgie
  consultation
  traitement
}

enum StatutDemande {
  soumise
  en_etude
  approuvee
  refusee
  expiree
  annulee
}

enum StatutVisite {
  favorable
  defavorable
  conditionnel
}

enum TypeRendezVous {
  visite
  rencontre
  adoption
}

enum StatutRendezVous {
  planifie
  honore
  annule
  no_show
}

enum StatutReservation {
  active
  expiree
  annulee
  convertie
}

enum StatutAdoption {
  brouillon
  finalisee
  annulee
  retour
}

enum ModePaiement {
  especes
  carte
  virement
}

enum SuiteRetour {
  repropose
  transfert
  decede
  autre
}

enum StatutFamille {
  active
  suspendue
  terminee
}

model personne {
  id_personne    BigInt             @id @default(autoincrement())
  nom            String
  prenom         String
  email          String             @unique
  tel            String?            @db.VarChar(100)
  date_naissance DateTime?          @db.Date
  jardin         Boolean?           @db.TinyInt
  rue            String?            @db.VarChar(255)
  numero         String?            @db.VarChar(50)
  code_postal    String?            @db.VarChar(20)
  ville          String?            @db.VarChar(255)
  pays           String?            @db.VarChar(255)
  type_personne  TypePersonne?
  demandes       demande_adoption[]
  adoptions      adoption[]
  rendez_vous    rendez_vous[]
  familles       famille_accueil[]
  entrants       entree[]           @relation("EntreeSource")
}

model utilisateur {
  id_user         BigInt              @id @default(autoincrement())
  nom             String
  prenom          String
  email           String              @unique
  motdepasse_hash String
  role            RoleUtilisateur     @default(agent)
  actif           Boolean             @default(true) @db.TinyInt
  notes           note_comportement[]
  visites         visite_domicile[]
  rendez_vous     rendez_vous[]
}

model espece {
  id_espece BigInt   @id @default(autoincrement())
  libelle   String   @unique
  races     race[]
  animaux   animal[]
}

model race {
  id_race   BigInt        @id @default(autoincrement())
  libelle   String
  espece    espece        @relation(fields: [id_espece], references: [id_espece], onUpdate: Cascade, onDelete: Restrict)
  id_espece BigInt
  animaux   animal_race[]

  @@unique([id_espece, libelle])
}

model animal {
  id_animal          BigInt               @id @default(autoincrement())
  nom_usuel          String?              @db.VarChar(255)
  sexe               SexeAnimal
  date_naissance     DateTime?            @db.Date
  date_arrivee       DateTime             @db.Date
  statut             StatutAnimal         @default(arrive)
  couleur_robe       String?              @db.VarChar(255)
  poids_kg           Decimal?             @db.Decimal(6, 2)
  sterilise          Boolean              @default(false) @db.TinyInt
  date_sterilisation DateTime?            @db.Date
  microchip_no       String?              @unique @db.VarChar(255)
  description        String?              @db.Text
  espece             espece               @relation(fields: [id_espece], references: [id_espece], onUpdate: Cascade, onDelete: Restrict)
  id_espece          BigInt
  races              animal_race[]
  emplacements       animal_emplacement[]
  entrees            entree[]
  evenements         evenement_medical[]
  notes              note_comportement[]
  demandes           demande_animal[]
  reservations       reservation[]
  adoptions          adoption[]
  placements_fa      placement_fa[]
  documents          document[]
  rendezVous         rendez_vous[]        @relation("AnimalRendezVous")
}

model animal_race {
  id_animal   BigInt
  id_race     BigInt
  pourcentage Int?
  animal      animal @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Cascade)
  race        race   @relation(fields: [id_race], references: [id_race], onUpdate: Cascade, onDelete: Restrict)

  @@id([id_animal, id_race])
}

model emplacement {
  id_emplacement BigInt               @id @default(autoincrement())
  code           String               @unique
  type           String
  capacite       Int
  actif          Boolean              @default(true) @db.TinyInt
  animaux        animal_emplacement[]
}

model animal_emplacement {
  id_animal      BigInt
  date_debut     DateTime    @db.Date
  id_emplacement BigInt
  date_fin       DateTime?   @db.Date
  animal         animal      @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Cascade)
  emplacement    emplacement @relation(fields: [id_emplacement], references: [id_emplacement], onUpdate: Cascade, onDelete: Restrict)

  @@id([id_animal, date_debut])
}

model entree {
  id_entree       BigInt     @id @default(autoincrement())
  id_animal       BigInt
  date_entree     DateTime   @db.Date
  type            TypeEntree
  source_personne BigInt?
  details         String?    @db.Text
  animal          animal     @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Cascade)
  source          personne?  @relation("EntreeSource", fields: [source_personne], references: [id_personne], onUpdate: Cascade, onDelete: SetNull)
}

model veterinaire {
  id_vet      BigInt              @id @default(autoincrement())
  nom_cabinet String
  contact     String?             @db.VarChar(255)
  adresse     String?             @db.VarChar(255)
  evenements  evenement_medical[]
}

model evenement_medical {
  id_evt         BigInt       @id @default(autoincrement())
  id_animal      BigInt
  type           TypeActe
  sous_type      String?      @db.VarChar(255)
  date_evt       DateTime     @db.Date
  date_validite  DateTime?    @db.Date
  id_veterinaire BigInt?
  notes          String?      @db.Text
  animal         animal       @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Cascade)
  veterinaire    veterinaire? @relation(fields: [id_veterinaire], references: [id_vet], onUpdate: Cascade, onDelete: SetNull)
}

model note_comportement {
  id_note     BigInt      @id @default(autoincrement())
  id_animal   BigInt
  date_note   DateTime    @default(now()) @db.Date
  ok_chiens   Boolean?    @db.TinyInt
  ok_chats    Boolean?    @db.TinyInt
  ok_enfants  Boolean?    @db.TinyInt
  score       Int?
  id_user     BigInt
  commentaire String?     @db.Text
  animal      animal      @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Cascade)
  utilisateur utilisateur @relation(fields: [id_user], references: [id_user], onUpdate: Cascade, onDelete: Restrict)
}

model demande_adoption {
  id_demande         BigInt            @id @default(autoincrement())
  id_personne        BigInt
  date_depot         DateTime          @default(now()) @db.Date
  statut             StatutDemande     @default(soumise)
  type_logement      String?           @db.VarChar(255)
  jardin             Boolean?          @db.TinyInt
  accord_proprio     Boolean?          @db.TinyInt
  enfants            Boolean?          @db.TinyInt
  autres_animaux     String?           @db.VarChar(255)
  experience_animaux String?           @db.Text
  preferences        String?           @db.Text
  commentaire        String?           @db.Text
  personne           personne          @relation(fields: [id_personne], references: [id_personne], onUpdate: Cascade, onDelete: Restrict)
  animaux            demande_animal[]
  reservations       reservation[]
  visites            visite_domicile[]
  documents          document[]

  @@index([statut])
}

model demande_animal {
  id_demande BigInt
  id_animal  BigInt
  priorite   Int?
  demande    demande_adoption @relation(fields: [id_demande], references: [id_demande], onUpdate: Cascade, onDelete: Cascade)
  animal     animal           @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Restrict)

  @@id([id_demande, id_animal])
}

model visite_domicile {
  id_visite   BigInt           @id @default(autoincrement())
  id_demande  BigInt
  date_visite DateTime         @db.Date
  statut      StatutVisite
  id_user     BigInt
  notes       String?          @db.Text
  demande     demande_adoption @relation(fields: [id_demande], references: [id_demande], onUpdate: Cascade, onDelete: Cascade)
  utilisateur utilisateur      @relation(fields: [id_user], references: [id_user], onUpdate: Cascade, onDelete: Restrict)
}

model rendez_vous {
  id_rdv      BigInt           @id @default(autoincrement())
  id_personne BigInt
  id_animal   BigInt?
  date_heure  DateTime         @db.DateTime(0)
  type        TypeRendezVous
  statut      StatutRendezVous @default(planifie)
  id_user     BigInt
  notes       String?          @db.Text
  personne    personne         @relation(fields: [id_personne], references: [id_personne], onUpdate: Cascade, onDelete: Restrict)
  animal      animal?          @relation("AnimalRendezVous", fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: SetNull)
  utilisateur utilisateur      @relation(fields: [id_user], references: [id_user], onUpdate: Cascade, onDelete: Restrict)
}

model reservation {
  id_reservation BigInt            @id @default(autoincrement())
  id_animal      BigInt
  id_demande     BigInt
  date_debut     DateTime          @db.Date
  date_fin       DateTime?         @db.Date
  statut         StatutReservation @default(active)
  motif          String?           @db.Text
  animal         animal            @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Restrict)
  demande        demande_adoption  @relation(fields: [id_demande], references: [id_demande], onUpdate: Cascade, onDelete: Cascade)

  @@index([id_animal])
  @@index([id_demande])
}

model adoption {
  id_adoption              BigInt                @id @default(autoincrement())
  numero_contrat           String                @unique
  id_animal                BigInt
  id_personne              BigInt
  date_contrat             DateTime              @db.Date
  frais_total              Decimal               @default(0) @db.Decimal(10, 2)
  statut                   StatutAdoption        @default(brouillon)
  conditions_particulieres String?               @db.Text
  animal                   animal                @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Restrict)
  personne                 personne              @relation(fields: [id_personne], references: [id_personne], onUpdate: Cascade, onDelete: Restrict)
  paiements                paiement[]
  retour                   retour_post_adoption?
  documents                document[]

  @@index([statut])
}

model paiement {
  id_paiement   BigInt       @id @default(autoincrement())
  id_adoption   BigInt
  date_paiement DateTime     @default(now()) @db.Date
  montant       Decimal      @db.Decimal(10, 2)
  mode          ModePaiement
  reference     String?      @db.VarChar(255)
  adoption      adoption     @relation(fields: [id_adoption], references: [id_adoption], onUpdate: Cascade, onDelete: Cascade)
}

model retour_post_adoption {
  id_retour    BigInt       @id @default(autoincrement())
  id_adoption  BigInt       @unique
  date_retour  DateTime     @db.Date
  motif        String?      @db.VarChar(255)
  suite        SuiteRetour?
  commentaires String?      @db.Text
  adoption     adoption     @relation(fields: [id_adoption], references: [id_adoption], onUpdate: Cascade, onDelete: Cascade)
}

model famille_accueil {
  id_fa         BigInt         @id @default(autoincrement())
  id_personne   BigInt
  date_agrement DateTime       @db.Date
  statut        StatutFamille  @default(active)
  notes         String?        @db.Text
  personne      personne       @relation(fields: [id_personne], references: [id_personne], onUpdate: Cascade, onDelete: Restrict)
  placements    placement_fa[]
}

model placement_fa {
  id_placement BigInt          @id @default(autoincrement())
  id_animal    BigInt
  id_fa        BigInt
  date_debut   DateTime        @db.Date
  date_fin     DateTime?       @db.Date
  notes        String?         @db.Text
  animal       animal          @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: Restrict)
  famille      famille_accueil @relation(fields: [id_fa], references: [id_fa], onUpdate: Cascade, onDelete: Restrict)
}

model document {
  id_doc      BigInt            @id @default(autoincrement())
  id_animal   BigInt?
  id_adoption BigInt?
  id_demande  BigInt?
  type_doc    String            @db.VarChar(255)
  uri         String            @db.VarChar(512)
  date_doc    DateTime          @default(now()) @db.Date
  animal      animal?           @relation(fields: [id_animal], references: [id_animal], onUpdate: Cascade, onDelete: SetNull)
  adoption    adoption?         @relation(fields: [id_adoption], references: [id_adoption], onUpdate: Cascade, onDelete: SetNull)
  demande     demande_adoption? @relation(fields: [id_demande], references: [id_demande], onUpdate: Cascade, onDelete: SetNull)
}
